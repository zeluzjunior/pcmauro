{% extends 'base.html' %}
{% load static %}

{% block title %}Visualizar CA {{ ca.ca }}{% endblock %}

{% block extra_css %}
<!-- Tentar carregar CSS do OrgChartJS -->
<link rel="stylesheet" href="https://balkan.app/css/orgchart.css" onerror="this.onerror=null; this.href='https://cdn.balkan.app/shared/latest/orgchart.min.css'"/>
<style>
    #tree-maquinas {
        width: 100%;
        height: 600px;
        min-height: 600px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
        position: relative;
    }
    
    /* Garantir que o OrgChartJS tenha espaço suficiente */
    #tree-maquinas > div {
        width: 100% !important;
        height: 100% !important;
    }
    
    /* Ocultar o menu de controle do OrgChartJS */
    [data-ctrl-menu] {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'consultar_locais_e_cas' %}" class="text-white">Locais e CAs</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Visualizar CA {{ ca.ca }}</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mt-3">Visualizar Centro de Atividade</h1>
                <p class="lead">Detalhes completos do CA {{ ca.ca }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container-fluid px-5">
        <div class="row">
            <div class="col-12">
                    <!-- Informações Principais -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Informações Principais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">CA (Código do Centro de Atividade)</label>
                                <p class="form-control-plaintext">{{ ca.ca }}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Sigla</label>
                                <p class="form-control-plaintext">
                                    {% if ca.sigla %}
                                        <span class="badge bg-secondary fs-6">{{ ca.sigla }}</span>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-bold">Descrição</label>
                                <p class="form-control-plaintext">{{ ca.descricao|default:"Não informado" }}</p>
                            </div>
                        </div>
                            </div>
                        </div>

                <!-- Informações Adicionais -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info me-2"></i>Informações Adicionais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Índice</label>
                                <p class="form-control-plaintext">
                                    {% if ca.indice %}
                                        <span class="badge bg-info text-dark fs-6">{{ ca.indice }}</span>
                                    {% else %}
                                        <span class="text-muted">Não informado</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Encarregado Responsável</label>
                                <p class="form-control-plaintext">{{ ca.encarregado_responsavel|default:"Não informado" }}</p>
                            </div>
                        </div>
                            </div>
                        </div>

                <!-- Locais do Centro de Atividade -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>Locais do Centro de Atividade
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if ca.locais.all %}
                            <div class="row">
                                {% for local in ca.locais.all %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-warning">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title text-primary mb-0">
                                                        <i class="fas fa-map-marker-alt me-2"></i>Local {{ forloop.counter }}
                                                    </h6>
                                                    <a href="{% url 'visualizar_local' local.id %}" class="btn btn-sm btn-outline-primary" title="Visualizar detalhes do local">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold small">Local:</label>
                                                    <p class="mb-0">{{ local.local }}</p>
                                                </div>
                                                {% if local.observacoes %}
                                                    <div class="mb-2">
                                                        <label class="form-label fw-bold small">Observações:</label>
                                                        <p class="mb-0 text-muted small">{{ local.observacoes|truncatewords:15 }}</p>
                                                    </div>
                                                {% endif %}
                                                <div class="mt-2 pt-2 border-top">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        Criado em: {{ local.created_at|date:"d/m/Y H:i:s" }}<br>
                                                        <i class="fas fa-edit me-1"></i>
                                                        Atualizado em: {{ local.updated_at|date:"d/m/Y H:i:s" }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Nenhum local cadastrado para este Centro de Atividade.
                            </div>
                        {% endif %}
                            </div>
                        </div>

                <!-- Hierarquia de Máquinas -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap me-2"></i>Hierarquia de Máquinas do Centro de Atividade (CA {{ ca.ca }})
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if has_maquinas %}
                            <!-- Statistics -->
                            <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">Máquinas Primárias</h6>
                                        <p class="card-text mb-0 h4">{{ total_primarias }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">Relacionamentos</h6>
                                        <p class="card-text mb-0 h4">{{ total_relacionamentos }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">Total de Máquinas</h6>
                                        <p class="card-text mb-0 h4">{{ total_maquinas }}</p>
                                    </div>
                                </div>
                            </div>
                            </div>
                            
                            <!-- Chart Container -->
                            <div id="tree-maquinas"></div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Nenhuma máquina encontrada relacionada a este Centro de Atividade (CA {{ ca.ca }}).
                                <br><small>As máquinas precisam estar associadas a um Local do Centro de Atividade relacionado a este CA.</small>
                            </div>
                        {% endif %}
                        </div>
                    </div>

                    <!-- Informações do Sistema -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-database me-2"></i>Informações do Sistema
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">ID do Registro</label>
                                <p class="form-control-plaintext">{{ ca.id }}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Data de Criação</label>
                                <p class="form-control-plaintext">{{ ca.created_at|date:"d/m/Y H:i:s" }}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Última Atualização</label>
                                <p class="form-control-plaintext">{{ ca.updated_at|date:"d/m/Y H:i:s" }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'consultar_locais_e_cas' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Voltar para Lista
                    </a>
                    <div>
                        <a href="{% url 'consultar_locais_e_cas' %}?search={{ ca.ca }}" class="btn btn-info">
                            <i class="fas fa-search me-2"></i>Buscar Similar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    // Função para carregar o script do OrgChartJS
    function loadOrgChartScript() {
        return new Promise(function(resolve, reject) {
            // Verificar se já está carregado
            if (typeof OrgChart !== 'undefined') {
                resolve();
                return;
            }
            
            // Lista de CDNs para tentar (em ordem de preferência)
            var cdns = [
                'https://balkan.app/js/orgchart.js',  // URL oficial da documentação
                'https://cdn.balkan.app/shared/latest/orgchart.min.js',
                'https://unpkg.com/@balkangraph/orgchartjs@latest/dist/orgchart.min.js',
                'https://cdn.jsdelivr.net/npm/@balkangraph/orgchartjs@latest/dist/orgchart.min.js'
            ];
            
            var currentIndex = 0;
            
            function tryNextCDN() {
                if (currentIndex >= cdns.length) {
                    reject(new Error('Falha ao carregar OrgChartJS de todos os CDNs. Verifique sua conexão com a internet.'));
                    return;
                }
                
                var script = document.createElement('script');
                script.src = cdns[currentIndex];
                script.async = true;
                
                script.onload = function() {
                    console.log('OrgChartJS carregado com sucesso de:', cdns[currentIndex]);
                    // Aguardar um pouco para garantir que está disponível
                    var attempts = 0;
                    var checkInterval = setInterval(function() {
                        attempts++;
                        if (typeof OrgChart !== 'undefined') {
                            clearInterval(checkInterval);
                            resolve();
                        } else if (attempts > 20) { // 2 segundos de tentativas
                            clearInterval(checkInterval);
                            if (currentIndex < cdns.length - 1) {
                                currentIndex++;
                                tryNextCDN();
                            } else {
                                reject(new Error('OrgChart não está disponível após carregar o script'));
                            }
                        }
                    }, 100);
                };
                
                script.onerror = function() {
                    console.warn('Falha ao carregar de:', cdns[currentIndex]);
                    // Remover o script que falhou
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    currentIndex++;
                    tryNextCDN();
                };
                
                document.head.appendChild(script);
            }
            
            tryNextCDN();
        });
    }
    
    // Função para inicializar o chart
    function initOrgChart() {
        var nodes = {{ dados_json|safe }};
        
        console.log('=== DEBUG ORGCHART ===');
        console.log('Nodes recebidos:', nodes);
        console.log('Tipo de nodes:', typeof nodes);
        console.log('Número de nós:', nodes ? nodes.length : 0);
        console.log('Nodes é array?', Array.isArray(nodes));
        
        var treeElement = document.getElementById('tree-maquinas');
        if (!treeElement) {
            console.error('Elemento #tree-maquinas não encontrado');
            return;
        }
        
        if (!nodes || nodes.length === 0) {
            console.warn('Nenhum nó encontrado');
            treeElement.innerHTML = '<div class="alert alert-warning m-3"><strong>Informação:</strong> Nenhuma máquina primária encontrada para este Centro de Atividade (CA {{ ca.ca }}).<br><small>Verifique se existem máquinas classificadas como "MÁQUINAS PRINCIPAL" relacionadas a este CA através de Locais do Centro de Atividade.</small></div>';
            return;
        }
        
        // Verificar se há nós sem pid (raiz)
        var rootNodes = nodes.filter(function(n) { return !n.pid; });
        if (rootNodes.length === 0) {
            console.warn('Nenhum nó raiz encontrado');
            treeElement.innerHTML = '<div class="alert alert-warning m-3"><strong>Informação:</strong> Nenhuma máquina primária encontrada para este Centro de Atividade.<br><small>Todas as máquinas encontradas são secundárias. Verifique se existem máquinas classificadas como "MÁQUINAS PRINCIPAL".</small></div>';
            return;
        }
        
        // Verificar se OrgChart está disponível
        if (typeof OrgChart === 'undefined') {
            console.error('OrgChart não está definido!');
            treeElement.innerHTML = '<div class="alert alert-danger m-3"><strong>Erro:</strong> OrgChartJS não foi carregado corretamente.<br><small>Verifique o console do navegador (F12) para mais detalhes.</small></div>';
            return;
        }
        
        try {
            console.log('Inicializando OrgChart com', nodes.length, 'nós...');
            console.log('Primeiros 3 nós:', nodes.slice(0, 3));
            
            // Verificar se os nós têm a estrutura correta
            if (nodes.length > 0) {
                console.log('Estrutura do primeiro nó:', Object.keys(nodes[0]));
                console.log('Valores do primeiro nó:', nodes[0]);
            }
            
            var chart = new OrgChart(document.getElementById("tree-maquinas"), {
                nodeBinding: {
                    field_0: "field_0",  // descr_maquina
                    field_1: "field_1",  // cd_maquina
                    img_0: "img_0"        // foto da máquina
                },
                nodes: nodes,
                // Adicionar evento de clique para redirecionar para visualizar_maquina
                nodeMenu: false,
                menu: false,
                mouseScrool: OrgChart.action.none
            });
            
            console.log('Chart criado com sucesso:', chart);
            
            // Adicionar evento de clique nos nós
            chart.on('nodeClick', function(sender, args) {
                var nodeId = args.node.id;
                if (nodeId) {
                    // Construir URL para visualizar a máquina
                    var url = "{% url 'visualizar_maquina' 999999 %}".replace('999999', nodeId);
                    console.log('Redirecionando para máquina ID:', nodeId, 'URL:', url);
                    window.location.href = url;
                }
            });
            
            // Também adicionar listener de clique direto no container para capturar cliques em qualquer parte do nó
            treeElement.addEventListener('click', function(e) {
                // Encontrar o elemento do nó clicado
                var clickedElement = e.target;
                var nodeElement = null;
                
                // Subir na hierarquia DOM para encontrar o elemento do nó
                while (clickedElement && clickedElement !== treeElement) {
                    // Verificar se encontramos um elemento que representa um nó
                    if (clickedElement.getAttribute && (
                        clickedElement.getAttribute('node-id') || 
                        clickedElement.getAttribute('data-node-id') ||
                        clickedElement.closest('[node-id]') ||
                        clickedElement.closest('[data-node-id]')
                    )) {
                        nodeElement = clickedElement.closest('[node-id]') || clickedElement.closest('[data-node-id]') || clickedElement;
                        break;
                    }
                    clickedElement = clickedElement.parentElement;
                }
                
                if (nodeElement) {
                    var nodeId = nodeElement.getAttribute('node-id') || nodeElement.getAttribute('data-node-id');
                    if (nodeId) {
                        // Encontrar o nó correspondente nos dados
                        var clickedNode = nodes.find(function(n) {
                            return String(n.id) === String(nodeId);
                        });
                        
                        if (clickedNode && clickedNode.id) {
                            e.preventDefault();
                            e.stopPropagation();
                            var url = "{% url 'visualizar_maquina' 999999 %}".replace('999999', clickedNode.id);
                            console.log('Redirecionando para máquina ID:', clickedNode.id, 'URL:', url);
                            window.location.href = url;
                        }
                    }
                }
            });
            
            console.log('OrgChart inicializado com sucesso!', chart);
            console.log('Chart object:', chart);
        } catch (error) {
            console.error('Erro ao inicializar OrgChart:', error);
            console.error('Stack trace:', error.stack);
            treeElement.innerHTML = '<div class="alert alert-danger m-3"><strong>Erro:</strong> ' + error.message + '<br><small>Verifique o console do navegador (F12) para mais detalhes.</small></div>';
        }
    }
    
    // Aguardar o DOM e carregar o script
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            loadOrgChartScript().then(function() {
                initOrgChart();
            }).catch(function(error) {
                console.error('Erro ao carregar OrgChartJS:', error);
                var treeElement = document.getElementById('tree-maquinas');
                if (treeElement) {
                    var errorMsg = '<div class="alert alert-warning m-3">';
                    errorMsg += '<strong>Aviso:</strong> Não foi possível carregar o organograma.<br>';
                    errorMsg += '<small>' + error.message + '</small>';
                    errorMsg += '</div>';
                    treeElement.innerHTML = errorMsg;
                }
            });
        });
    } else {
        // DOM já carregado
        loadOrgChartScript().then(function() {
            initOrgChart();
        }).catch(function(error) {
            console.error('Erro ao carregar OrgChartJS:', error);
            var treeElement = document.getElementById('tree-maquinas');
            if (treeElement) {
                var errorMsg = '<div class="alert alert-warning m-3">';
                errorMsg += '<strong>Aviso:</strong> Não foi possível carregar o organograma.<br>';
                errorMsg += '<small>' + error.message + '</small>';
                errorMsg += '</div>';
                treeElement.innerHTML = errorMsg;
            }
        });
    }
</script>
{% endblock %}


