{% extends 'base.html' %}
{% load static %}

{% block title %}Análise de Máquinas Importadas{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
    .chart-container-large {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .kpi-card {
        border-left: 4px solid;
    }
    .kpi-primary { border-left-color: #0d6efd; }
    .kpi-success { border-left-color: #198754; }
    .kpi-warning { border-left-color: #ffc107; }
    .kpi-info { border-left-color: #0dcaf0; }
    .kpi-danger { border-left-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white">Home</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Máquinas</li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Análise de Importadas</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mt-3">Análise de Máquinas Importadas</h1>
                <p class="lead">Dashboard com análises e estatísticas das máquinas importadas</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container">
        <!-- KPI Cards -->
        <div class="mb-5">
            <div class="row mb-4">
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-primary shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Total de Máquinas Importadas</h6>
                                    <h2 class="mb-0 fw-bold">{{ total_importadas }}</h2>
                                </div>
                                <i class="fas fa-download fa-3x text-primary opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-success shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Últimos 30 Dias</h6>
                                    <h2 class="mb-0 fw-bold">{{ importadas_recentes }}</h2>
                                </div>
                                <i class="fas fa-calendar-day fa-3x text-success opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-warning shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Mês Atual</h6>
                                    <h2 class="mb-0 fw-bold">{{ importadas_mes_atual }}</h2>
                                </div>
                                <i class="fas fa-calendar-alt fa-3x text-warning opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-info shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Percentual do Total</h6>
                                    <h2 class="mb-0 fw-bold">{{ percentual_importadas }}%</h2>
                                </div>
                                <i class="fas fa-percentage fa-3x text-info opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-5">
            <!-- Gráfico de Linha: Evolução Temporal -->
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Evolução Temporal das Importações (Últimos 12 Meses)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="temporalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-5">
            <!-- Gráfico de Pizza: Distribuição por Setor -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Distribuição por Setor de Manutenção
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="setoresChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Barras: Distribuição por Unidade -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Distribuição por Unidade (Top 10)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="unidadesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Máquinas Agrupadas por Gerência -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap me-2"></i>Máquinas Importadas Agrupadas por Gerência
                            <small class="ms-2">({{ maquinas_por_gerencia|length }} classificação{{ maquinas_por_gerencia|length|pluralize:"es" }})</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if maquinas_por_gerencia %}
                            <div class="accordion" id="accordionGerencia">
                                {% for gerencia, maquinas in maquinas_por_gerencia %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ forloop.counter }}">
                                                <strong>
                                                    <i class="fas fa-building me-2"></i>{{ gerencia }}
                                                    <span class="badge bg-primary ms-2">{{ maquinas|length }} máquina{{ maquinas|length|pluralize:"s" }}</span>
                                                </strong>
                                            </button>
                                        </h2>
                                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#accordionGerencia">
                                            <div class="accordion-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover table-sm mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th style="width: 5%;">#</th>
                                                                <th style="width: 10%;">Código</th>
                                                                <th style="width: 35%;">Descrição</th>
                                                                <th style="width: 10%;">Setor</th>
                                                                <th style="width: 15%;">Unidade</th>
                                                                <th style="width: 15%;">Data Importação</th>
                                                                <th style="width: 10%;" class="text-center">Ações</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for maquina in maquinas %}
                                                                <tr>
                                                                    <td><strong>{{ forloop.counter }}</strong></td>
                                                                    <td>
                                                                        <span class="badge bg-primary">{{ maquina.cd_maquina }}</span>
                                                                    </td>
                                                                    <td>{{ maquina.descr_maquina|truncatewords:15 }}</td>
                                                                    <td><small>{{ maquina.cd_setormanut|default:"-" }}</small></td>
                                                                    <td><small>{{ maquina.nome_unid|default:"-" }}</small></td>
                                                                    <td><small>{{ maquina.created_at|date:"d/m/Y H:i" }}</small></td>
                                                                    <td class="text-center">
                                                                        <a href="{% url 'visualizar_maquina' maquina.id %}" class="btn btn-sm btn-outline-primary" title="Visualizar máquina">
                                                                            <i class="fas fa-eye"></i>
                                                                        </a>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info m-3 mb-0">
                                <i class="fas fa-info-circle me-2"></i>Nenhuma máquina importada encontrada com classificação de gerência.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="row mb-5">
            <!-- Tabela: Máquinas Importadas Recentes -->
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Máquinas Importadas Recentes
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Código</th>
                                        <th>Descrição</th>
                                        <th>Setor</th>
                                        <th>Unidade</th>
                                        <th>Data Importação</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for maquina in maquinas_importadas_recentes %}
                                    <tr>
                                        <td><strong>{{ forloop.counter }}</strong></td>
                                        <td><span class="badge bg-primary">{{ maquina.cd_maquina }}</span></td>
                                        <td>{{ maquina.descr_maquina|truncatewords:10 }}</td>
                                        <td>{{ maquina.cd_setormanut|default:"-" }}</td>
                                        <td>{{ maquina.nome_unid|default:"-" }}</td>
                                        <td>{{ maquina.created_at|date:"d/m/Y H:i" }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'visualizar_maquina' maquina.id %}" class="btn btn-sm btn-outline-primary" title="Visualizar máquina">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Nenhuma máquina importada encontrada</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Linha: Evolução Temporal
    const temporalCtx = document.getElementById('temporalChart');
    if (temporalCtx) {
        new Chart(temporalCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: {{ meses_labels|safe }},
                datasets: [{
                    label: 'Máquinas Importadas',
                    data: {{ meses_data|safe }},
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Gráfico de Pizza: Distribuição por Setor
    const setoresCtx = document.getElementById('setoresChart');
    if (setoresCtx) {
        const colors = [
            '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
            '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
        ];
        
        const setoresLabels = {{ setores_labels|safe }};
        const setoresData = {{ setores_data|safe }};
        const backgroundColors = setoresLabels.map(function(_, index) {
            return colors[index % colors.length];
        });

        new Chart(setoresCtx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: setoresLabels,
                datasets: [{
                    label: 'Quantidade de Máquinas',
                    data: setoresData,
                    backgroundColor: backgroundColors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    // Gráfico de Barras: Distribuição por Unidade
    const unidadesCtx = document.getElementById('unidadesChart');
    if (unidadesCtx) {
        new Chart(unidadesCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ unidades_labels|safe }},
                datasets: [{
                    label: 'Máquinas',
                    data: {{ unidades_data|safe }},
                    backgroundColor: '#0dcaf0'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}

