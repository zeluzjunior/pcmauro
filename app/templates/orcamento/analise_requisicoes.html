{% extends 'base.html' %}
{% load static %}
{% load form_extras %}

{% block title %}Análise de Requisições{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
    .chart-container-large {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .kpi-card {
        border-left: 4px solid;
    }
    .kpi-primary { border-left-color: #0d6efd; }
    .kpi-success { border-left-color: #198754; }
    .kpi-warning { border-left-color: #ffc107; }
    .kpi-info { border-left-color: #0dcaf0; }
    .kpi-danger { border-left-color: #dc3545; }
    .kpi-purple { border-left-color: #6f42c1; }
    
    /* Estilo para o seletor de mês */
    #mesSelecionado {
        transition: all 0.3s ease;
        cursor: pointer;
        font-weight: 500;
    }
    #mesSelecionado:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
    }
    #mesSelecionado:focus {
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        border-color: #198754;
        outline: none;
    }
    .input-group-text {
        transition: all 0.3s ease;
    }
    .input-group:hover .input-group-text {
        background-color: #f8f9fa !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white">Home</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Orçamento</li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Análise de Requisições</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mt-3">
                    <i class="fas fa-chart-line me-2"></i>Análise de Requisições
                </h1>
                <p class="lead">Dashboard com análises e estatísticas de requisições de almoxarifado</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container">
        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>Filtros de Análise
                        </h5>
                        {% if data_inicio or data_fim or ano_selecionado %}
                        <span class="badge bg-light text-primary">
                            <i class="fas fa-check-circle me-1"></i>Filtros Ativos ({{ total_requisicoes }} registros)
                        </span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <form method="get" action="{% url 'analise_requisicoes' %}" id="filtrosForm">
                            <div class="row g-3">
                                <!-- Filtro 1: Intervalo de Datas -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Intervalo de Datas</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">Data Inicial</label>
                                            <input type="date" 
                                                   class="form-control" 
                                                   name="data_inicio" 
                                                   id="dataInicio"
                                                   value="{{ data_inicio }}">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">Data Final</label>
                                            <input type="date" 
                                                   class="form-control" 
                                                   name="data_fim" 
                                                   id="dataFim"
                                                   value="{{ data_fim }}">
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Selecione um intervalo de datas para filtrar as análises
                                    </small>
                                </div>
                                
                                <!-- Filtro 2: Ano e Mês -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Ano e Mês</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">Ano</label>
                                            <select class="form-select" 
                                                    name="ano" 
                                                    id="anoSelecionado">
                                                <option value="">Todos os anos</option>
                                                {% for ano in anos_disponiveis %}
                                                <option value="{{ ano }}" {% if ano_selecionado == ano|stringformat:"s" %}selected{% endif %}>
                                                    {{ ano }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">Mês</label>
                                            <select class="form-select" 
                                                    name="mes" 
                                                    id="mesSelecionadoFiltro"
                                                    {% if not ano_selecionado %}disabled{% endif %}>
                                                <option value="">Todos os meses</option>
                                                {% if ano_selecionado %}
                                                    {% for mes_num in meses_ano_selecionado %}
                                                    <option value="{{ mes_num }}" {% if mes_selecionado_filtro == mes_num|stringformat:"s" %}selected{% endif %}>
                                                        {{ meses_nomes|get_item:mes_num }}
                                                    </option>
                                                    {% endfor %}
                                                {% endif %}
                                            </select>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Selecione um ano e opcionalmente um mês específico
                                    </small>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary me-2" id="aplicarFiltrosBtn">
                                        <i class="fas fa-search me-2"></i>Aplicar Filtros
                                    </button>
                                    <a href="{% url 'analise_requisicoes' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Limpar Filtros
                                    </a>
                                    {% if data_inicio or data_fim or ano_selecionado %}
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% if data_inicio or data_fim %}
                                                Filtro de intervalo de datas ativo
                                            {% elif ano_selecionado %}
                                                Filtro de ano{% if mes_selecionado_filtro %} e mês{% endif %} ativo
                                            {% endif %}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI Cards -->
        <div class="mb-5">
            <div class="row mb-4">
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-primary shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Total de Requisições
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Número total de requisições de almoxarifado registradas no sistema"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ total_requisicoes }}</h2>
                                </div>
                                <i class="fas fa-clipboard-list fa-3x text-primary opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-success shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Últimos 30 Dias
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Número de requisições criadas nos últimos 30 dias"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ requisicoes_recentes }}</h2>
                                </div>
                                <i class="fas fa-calendar-day fa-3x text-success opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-warning shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Mês Atual
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Número de requisições criadas no mês atual"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ requisicoes_mes_atual }}</h2>
                                </div>
                                <i class="fas fa-calendar-alt fa-3x text-warning opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-info shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Itens Únicos
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Número de itens diferentes que foram requisitados pelo menos uma vez"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ itens_unicos }}</h2>
                                </div>
                                <i class="fas fa-boxes fa-3x text-info opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-danger shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Valor Total
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Soma de todos os valores das requisições (valor total de todos os itens requisitados)"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ valor_total|currency_br }}</h2>
                                </div>
                                <i class="fas fa-dollar-sign fa-3x text-danger opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-purple shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Valor Médio
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Valor médio por requisição (Valor Total dividido pelo número total de requisições)"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ valor_medio|currency_br }}</h2>
                                </div>
                                <i class="fas fa-chart-line fa-3x text-purple opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-success shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Centros de Atividade
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Número de centros de atividade diferentes que realizaram requisições"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ centros_unicos }}</h2>
                                </div>
                                <i class="fas fa-building fa-3x text-success opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="card stat-card kpi-card kpi-info shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">
                                        Total de Itens Requisitados
                                        <i class="fas fa-info-circle ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Soma de todas as quantidades de itens retirados do estoque em todas as requisições"></i>
                                    </h6>
                                    <h2 class="mb-0 fw-bold">{{ quantidade_total|number_br:2 }}</h2>
                                </div>
                                <i class="fas fa-boxes fa-3x text-info opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Charts Row 1.5: Daily Chart -->
        <div class="row mb-5">
            <!-- Gráfico de Linha: Evolução Diária do Mês -->
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>Evolução Diária das Requisições por Mês
                            </h5>
                            <div class="d-flex align-items-center mt-2 mt-md-0">
                                <div class="input-group" style="max-width: 220px;">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-calendar-alt text-success"></i>
                                    </span>
                                    <input type="month" 
                                           class="form-control border-start-0" 
                                           id="mesSelecionado" 
                                           value="{{ mes_selecionado }}"
                                           style="font-weight: 500;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-5">
            <!-- Gráfico de Barras: Top 10 Itens por Quantidade -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Top 10 Itens Mais Requisitados (Quantidade)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="itensQtdChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Barras: Top 10 Itens por Valor -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Top 10 Itens por Valor Total
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="itensValorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 3 -->
        <div class="row mb-5">
            <!-- Gráfico de Barras: Distribuição por Centro de Atividade -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Top 10 Centros de Atividade por Valor
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="centrosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Pizza: Distribuição por Operação -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Top 10 Operações Mais Frequentes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="operacoesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 4 -->
        <div class="row mb-5">
            <!-- Gráfico de Barras: Distribuição por Usuário Criou -->
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-chart me-2"></i>Top 10 Usuários que Criaram Requisições
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="usuariosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="row mb-5">
            <!-- Tabela: Requisições Recentes -->
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Requisições Recentes
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Código Item</th>
                                        <th>Descrição Item</th>
                                        <th class="text-end">Quantidade</th>
                                        <th class="text-end">Valor Unit.</th>
                                        <th class="text-end">Valor Total</th>
                                        <th>Centro Atividade</th>
                                        <th>Operação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for requisicao in requisicoes_recentes_list %}
                                    <tr>
                                        <td>{{ requisicao.data_requisicao|date:"d/m/Y" }}</td>
                                        <td><span class="badge bg-primary">{{ requisicao.cd_item }}</span></td>
                                        <td>{{ requisicao.descr_item|default:"-"|truncatewords:10 }}</td>
                                        <td class="text-end">
                                            {% if requisicao.qtde_movto_estoq %}
                                                {{ requisicao.qtde_movto_estoq|floatformat:2 }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if requisicao.vlr_movto_estoq %}
                                                {{ requisicao.vlr_movto_estoq|currency_br }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if requisicao.valor_total %}
                                                {{ requisicao.valor_total|currency_br }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ requisicao.cd_centro_ativ|default:"-" }}</td>
                                        <td>{{ requisicao.descr_operacao|default:"-"|truncatewords:5 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Nenhuma requisição encontrada</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-5">
            <!-- Gráfico de Linha: Evolução Temporal -->
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Evolução Temporal das Requisições (Últimos 12 Meses)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="temporalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Handle year/month filter dependency
    const anoSelecionado = document.getElementById('anoSelecionado');
    const mesSelecionadoFiltro = document.getElementById('mesSelecionadoFiltro');
    const dataInicio = document.getElementById('dataInicio');
    const dataFim = document.getElementById('dataFim');
    const aplicarFiltrosBtn = document.getElementById('aplicarFiltrosBtn');
    
    // Disable year/month filters when date range is used
    function updateFilterStates() {
        const temDataRange = (dataInicio && dataInicio.value) || (dataFim && dataFim.value);
        
        if (temDataRange) {
            if (anoSelecionado) {
                anoSelecionado.disabled = true;
                anoSelecionado.value = '';
            }
            if (mesSelecionadoFiltro) {
                mesSelecionadoFiltro.disabled = true;
                mesSelecionadoFiltro.innerHTML = '<option value="">Todos os meses</option>';
            }
        } else {
            if (anoSelecionado) {
                anoSelecionado.disabled = false;
            }
            if (mesSelecionadoFiltro && anoSelecionado && anoSelecionado.value) {
                mesSelecionadoFiltro.disabled = false;
            }
        }
    }
    
    // Listen for date range changes
    if (dataInicio) {
        dataInicio.addEventListener('change', updateFilterStates);
    }
    if (dataFim) {
        dataFim.addEventListener('change', updateFilterStates);
    }
    
    // Initial state
    updateFilterStates();
    
    if (anoSelecionado && mesSelecionadoFiltro) {
        anoSelecionado.addEventListener('change', function() {
            const ano = this.value;
            
            if (ano && !anoSelecionado.disabled) {
                // Fetch months for selected year
                const apiUrl = '{% url "api_meses_por_ano" %}';
                fetch(`${apiUrl}?ano=${ano}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Erro ao carregar meses:', data.error);
                            return;
                        }
                        
                        // Clear and populate month dropdown
                        mesSelecionadoFiltro.innerHTML = '<option value="">Todos os meses</option>';
                        mesSelecionadoFiltro.disabled = false;
                        
                        data.meses.forEach(function(mes) {
                            const option = document.createElement('option');
                            option.value = mes.value;
                            option.textContent = mes.label;
                            mesSelecionadoFiltro.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao carregar meses:', error);
                    });
            } else {
                // No year selected, disable month dropdown
                mesSelecionadoFiltro.innerHTML = '<option value="">Todos os meses</option>';
                if (!ano) {
                    mesSelecionadoFiltro.disabled = true;
                }
            }
        });
    }
    
    // Form submission handler - ensure form submits correctly
    // Need to prevent main.js from interfering
    setTimeout(function() {
        const filtrosForm = document.getElementById('filtrosForm');
        const aplicarFiltrosBtn = document.getElementById('aplicarFiltrosBtn');
        
        if (filtrosForm && aplicarFiltrosBtn) {
            // Clone button to remove main.js listeners
            const newBtn = aplicarFiltrosBtn.cloneNode(true);
            aplicarFiltrosBtn.parentNode.replaceChild(newBtn, aplicarFiltrosBtn);
            const cleanBtn = document.getElementById('aplicarFiltrosBtn');
            
            // Clone form to remove main.js listeners
            const newForm = filtrosForm.cloneNode(true);
            filtrosForm.parentNode.replaceChild(newForm, filtrosForm);
            const cleanForm = document.getElementById('filtrosForm');
            
            // Re-attach the cloned button to the cloned form
            const btnContainer = cleanForm.querySelector('.row.mt-3 .col-12');
            if (btnContainer && cleanBtn) {
                const existingBtn = btnContainer.querySelector('#aplicarFiltrosBtn');
                if (!existingBtn) {
                    btnContainer.insertBefore(cleanBtn, btnContainer.firstChild);
                }
            }
            
            // Add submit handler that doesn't prevent default
            if (cleanForm) {
                cleanForm.addEventListener('submit', function(e) {
                    console.log('Filter form submitting...');
                    // Show loading state but don't prevent submission
                    if (cleanBtn) {
                        cleanBtn.disabled = true;
                        cleanBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Aplicando...';
                    }
                    // Let form submit normally - don't call e.preventDefault()
                }, true); // Use capture phase
            }
            
            // Also handle button click
            if (cleanBtn) {
                cleanBtn.addEventListener('click', function(e) {
                    console.log('Filter button clicked');
                    // Don't prevent default - let form submit
                }, true);
            }
        }
    }, 200); // Wait for main.js to finish
    
    // Gráfico de Linha: Evolução Temporal
    const temporalCtx = document.getElementById('temporalChart');
    if (temporalCtx) {
        new Chart(temporalCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: {{ meses_labels|safe }},
                datasets: [{
                    label: 'Quantidade de Requisições',
                    data: {{ meses_data|safe }},
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                }, {
                    label: 'Valor Total (R$)',
                    data: {{ meses_valor|safe }},
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valor (R$)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }

    // Gráfico de Barras: Top 10 Itens por Quantidade
    const itensQtdCtx = document.getElementById('itensQtdChart');
    if (itensQtdCtx) {
        new Chart(itensQtdCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ top_itens_labels|safe }},
                datasets: [{
                    label: 'Quantidade',
                    data: {{ top_itens_data|safe }},
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Gráfico de Barras: Top 10 Itens por Valor
    const itensValorCtx = document.getElementById('itensValorChart');
    if (itensValorCtx) {
        new Chart(itensValorCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ top_itens_valor_labels|safe }},
                datasets: [{
                    label: 'Valor Total (R$)',
                    data: {{ top_itens_valor_data|safe }},
                    backgroundColor: '#dc3545'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    // Gráfico de Barras: Top 10 Centros de Atividade
    const centrosCtx = document.getElementById('centrosChart');
    if (centrosCtx) {
        new Chart(centrosCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ centros_labels|safe }},
                datasets: [{
                    label: 'Valor Total (R$)',
                    data: {{ centros_data_valor|safe }},
                    backgroundColor: '#0dcaf0'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });
    }

    // Gráfico de Pizza: Top 10 Operações
    const operacoesCtx = document.getElementById('operacoesChart');
    if (operacoesCtx) {
        const colors = [
            '#ffc107', '#0d6efd', '#198754', '#dc3545', '#0dcaf0',
            '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
        ];
        
        const operacoesLabels = {{ operacoes_labels|safe }};
        const operacoesData = {{ operacoes_data|safe }};
        const backgroundColors = operacoesLabels.map(function(_, index) {
            return colors[index % colors.length];
        });

        new Chart(operacoesCtx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: operacoesLabels,
                datasets: [{
                    label: 'Quantidade de Requisições',
                    data: operacoesData,
                    backgroundColor: backgroundColors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    // Gráfico de Linha: Evolução Diária do Mês
    const dailyCtx = document.getElementById('dailyChart');
    let dailyChart = null;
    
    function updateDailyChart(mesAno) {
        // Mostrar loading
        if (dailyChart) {
            dailyChart.destroy();
        }
        
        // Fazer requisição AJAX
        const apiUrl = '{% url "api_dados_diarios_requisicoes" %}';
        fetch(`${apiUrl}?mes_ano=${mesAno}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Erro ao carregar dados:', data.error);
                    return;
                }
                
                if (dailyCtx) {
                    dailyChart = new Chart(dailyCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'Quantidade de Requisições',
                                data: data.data,
                                borderColor: '#198754',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            }, {
                                label: 'Valor Total (R$)',
                                data: data.valor,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Quantidade'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Valor (R$)'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao carregar dados diários:', error);
            });
    }
    
    // Inicializar gráfico com dados iniciais
    if (dailyCtx) {
        const mesSelecionado = document.getElementById('mesSelecionado');
        const mesInicial = mesSelecionado ? mesSelecionado.value : '{{ mes_selecionado }}';
        
        const diasLabels = {{ dias_labels|safe }};
        const diasData = {{ dias_data|safe }};
        const diasValor = {{ dias_valor|safe }};
        
        dailyChart = new Chart(dailyCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: diasLabels,
                datasets: [{
                    label: 'Quantidade de Requisições',
                    data: diasData,
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                }, {
                    label: 'Valor Total (R$)',
                    data: diasValor,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valor (R$)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
        
        // Listener para mudança de mês
        if (mesSelecionado) {
            mesSelecionado.addEventListener('change', function() {
                updateDailyChart(this.value);
            });
        }
    }

    // Gráfico de Barras: Top 10 Usuários que Criaram Requisições
    const usuariosCtx = document.getElementById('usuariosChart');
    if (usuariosCtx) {
        new Chart(usuariosCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ usuarios_labels|safe }},
                datasets: [{
                    label: 'Quantidade de Requisições',
                    data: {{ usuarios_data_count|safe }},
                    backgroundColor: '#6c757d',
                    yAxisID: 'y'
                }, {
                    label: 'Valor Total (R$)',
                    data: {{ usuarios_data_valor|safe }},
                    backgroundColor: '#495057',
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valor (R$)'
                        },
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
