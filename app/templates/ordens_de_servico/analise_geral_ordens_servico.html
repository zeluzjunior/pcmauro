{% extends 'base.html' %}
{% load static %}
{% load form_extras %}

{% block title %}Análise de Ordens de Serviço{% endblock %}

{% block extra_css %}
<!-- Chart.js CSS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
    .chart-container-large {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid transparent;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .stat-card.border-primary { border-left-color: #0d6efd; }
    .stat-card.border-success { border-left-color: #198754; }
    .stat-card.border-info { border-left-color: #0dcaf0; }
    .stat-card.border-warning { border-left-color: #ffc107; }
    .stat-card.border-danger { border-left-color: #dc3545; }
    .stat-card.border-secondary { border-left-color: #6c757d; }
    
    .section-header {
        border-bottom: 3px solid;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .info-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .kpi-card {
        border-left: 4px solid;
    }
    .kpi-primary { border-left-color: #0d6efd; }
    .kpi-success { border-left-color: #198754; }
    .kpi-warning { border-left-color: #ffc107; }
    .kpi-info { border-left-color: #0dcaf0; }
    .kpi-danger { border-left-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white">Home</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Análise de Ordens de Serviço</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mt-3">
                    <i class="fas fa-chart-bar me-2"></i>Análise de Ordens de Serviço
                </h1>
                <p class="lead">Dashboard com estatísticas e análises das ordens de serviço corretivas e fichas de manutenção</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container">
        <!-- Filtro de Ano e Mês (Accordion) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="accordion" id="filtrosAccordion">
                    <div class="accordion-item shadow-sm border-0">
                        <h2 class="accordion-header" id="filtrosHeading">
                            <button class="accordion-button {% if not meses_filtro %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse" aria-expanded="{% if meses_filtro %}true{% else %}false{% endif %}" aria-controls="filtrosCollapse">
                                <i class="fas fa-filter me-2"></i>
                                <strong>Filtros</strong>
                                {% if meses_filtro or ano_filtro %}
                                    <span class="badge bg-info ms-2">
                                        {% if meses_filtro %}
                                            {% if meses_filtro|length == 1 %}
                                                {{ meses_nomes|get_item:meses_filtro.0 }} de {{ ano_filtro }}
                                            {% else %}
                                                {{ meses_filtro|length }} meses de {{ ano_filtro }}
                                            {% endif %}
                                        {% else %}
                                            Todos os meses de {{ ano_filtro }}
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="filtrosCollapse" class="accordion-collapse collapse {% if meses_filtro %}show{% endif %}" aria-labelledby="filtrosHeading" data-bs-parent="#filtrosAccordion">
                            <div class="accordion-body">
                                <form method="get" action="{% url 'analise_ordens_de_servico' %}" class="row g-3">
                                    <div class="col-md-4">
                                        <label for="ano" class="form-label">Ano</label>
                                        <select class="form-select" id="ano" name="ano" required>
                                            {% for ano in anos_disponiveis %}
                                                <option value="{{ ano }}" {% if ano == ano_filtro %}selected{% endif %}>{{ ano }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Meses (Selecione múltiplos meses ou deixe todos desmarcados para todos os meses)</label>
                                        <div class="row g-2">
                                            {% for i in "123456789012" %}
                                                {% with mes_num=forloop.counter %}
                                                    <div class="col-md-3 col-sm-4 col-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" name="mes" value="{{ mes_num }}" id="mes{{ mes_num }}" {% if mes_num in meses_filtro %}checked{% endif %}>
                                                            <label class="form-check-label" for="mes{{ mes_num }}">{{ meses_nomes|get_item:mes_num }}</label>
                                                        </div>
                                                    </div>
                                                {% endwith %}
                                            {% endfor %}
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selecionarTodosMeses()">Selecionar Todos</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="desmarcarTodosMeses()">Desmarcar Todos</button>
                                        </div>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search me-2"></i>Filtrar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI Cards -->
        <div class="row mb-5">
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-primary shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Total de Ordens</h6>
                                <h2 class="mb-0 fw-bold">{{ total_corretivas }}</h2>
                                <small class="text-muted">Ordens corretivas</small>
                            </div>
                            <i class="fas fa-clipboard-list fa-3x text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-success shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Com Executor</h6>
                                <h2 class="mb-0 fw-bold">{{ taxa_ordens_com_executor|floatformat:1 }}%</h2>
                                <small class="text-muted">{{ ordens_com_executor }} com / {{ ordens_sem_executor }} sem</small>
                            </div>
                            <i class="fas fa-user-check fa-3x text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-info shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Com Fichas</h6>
                                <h2 class="mb-0 fw-bold">{{ taxa_ordens_com_fichas|floatformat:1 }}%</h2>
                                <small class="text-muted">{{ ordens_com_fichas }} com / {{ ordens_sem_fichas }} sem</small>
                            </div>
                            <i class="fas fa-file-alt fa-3x text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-warning shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Total de Fichas</h6>
                                <h2 class="mb-0 fw-bold">{{ total_fichas }}</h2>
                                <small class="text-muted">Média: {{ media_fichas_por_ordem|floatformat:1 }} por ordem</small>
                            </div>
                            <i class="fas fa-file-invoice fa-3x text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1: Tipo de Ordem (MUITO IMPORTANTE) e Evolução Temporal -->
        <div class="row mb-5">
            <!-- Gráfico de Pizza: Distribuição por Tipo de Ordem (descr_tpordservtv) -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Distribuição por Tipo de Ordem (Top 10)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tiposOSChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Linha: Evolução Temporal -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Evolução Temporal (Ano Completo)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="temporalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2: Setores e Unidades -->
        <div class="row mb-5">
            <!-- Gráfico de Pizza: Distribuição por Setor -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Distribuição por Setor (Top 10)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="setoresChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Barras: Distribuição por Unidade -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Distribuição por Unidade (Top 10)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="unidadesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 3: Máquinas e Executores -->
        <div class="row mb-5">
            <!-- Gráfico de Barras Horizontal: Top Máquinas -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Top 10 Máquinas com Mais Ordens
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="maquinasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Barras: Top Executores -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>Top 10 Executores
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="executoresChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 4: Executores de Fichas -->
        <div class="row mb-5">
            <div class="col-md-12 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-tie me-2"></i>Top 10 Executores de Fichas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="executoresFichasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Análise OrdemServicoCorretiva -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-white">
                <h4 class="mb-0 section-header border-white">
                    <i class="fas fa-tools me-2"></i>Análise de Ordens Corretivas (OrdemServicoCorretiva)
                </h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Com Máquina</h6>
                                <h2 class="text-success mb-0">{{ ordens_com_maquina }}</h2>
                                <small class="text-muted">{{ taxa_ordens_com_maquina|floatformat:1 }}% do total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-danger h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Sem Máquina</h6>
                                <h2 class="text-danger mb-0">{{ ordens_sem_maquina }}</h2>
                                <small class="text-muted">{{ ordens_sem_maquina }} ordens</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-info h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Com Executor</h6>
                                <h2 class="text-info mb-0">{{ ordens_com_executor }}</h2>
                                <small class="text-muted">{{ taxa_ordens_com_executor|floatformat:1 }}% do total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-secondary h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Com Solicitante</h6>
                                <h2 class="text-secondary mb-0">{{ ordens_com_solicitante }}</h2>
                                <small class="text-muted">{{ ordens_com_solicitante }} ordens</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ordens por Setor -->
                {% if ordens_por_setor %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-building me-2"></i>Top 10 Setores com Mais Ordens</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Setor</th>
                                    <th class="text-end">Total de Ordens</th>
                                    <th class="text-end">Percentual</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ordens_por_setor %}
                                <tr>
                                    <td>{{ item.descr_setormanut|truncatechars:50 }}</td>
                                    <td class="text-end"><strong>{{ item.total }}</strong></td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">
                                            {% widthratio item.total total_corretivas 100 %}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                
                <!-- Top Máquinas -->
                {% if top_maquinas %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-cogs me-2"></i>Top 10 Máquinas com Mais Ordens</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Descrição</th>
                                    <th class="text-end">Total de Ordens</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in top_maquinas %}
                                <tr>
                                    <td><strong>{{ item.cd_maquina }}</strong></td>
                                    <td>{{ item.descr_maquina|truncatechars:60|default:"-" }}</td>
                                    <td class="text-end"><span class="badge bg-warning text-dark">{{ item.total }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Seção: Análise OrdemServicoCorretivaFicha -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0 section-header border-white">
                    <i class="fas fa-file-alt me-2"></i>Análise de Fichas de Manutenção (OrdemServicoCorretivaFicha)
                </h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-primary h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Total de Fichas</h6>
                                <h2 class="text-primary mb-0">{{ total_fichas }}</h2>
                                <small class="text-muted">Fichas cadastradas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Ordens com Fichas</h6>
                                <h2 class="text-success mb-0">{{ ordens_com_fichas }}</h2>
                                <small class="text-muted">{{ taxa_ordens_com_fichas|floatformat:1 }}% do total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-warning h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Ordens sem Fichas</h6>
                                <h2 class="text-warning mb-0">{{ ordens_sem_fichas }}</h2>
                                <small class="text-muted">{{ ordens_sem_fichas }} ordens</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-info h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Média Fichas/Ordem</h6>
                                <h2 class="text-info mb-0">{{ media_fichas_por_ordem|floatformat:1 }}</h2>
                                <small class="text-muted">Fichas por ordem</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Ordens com Fichas -->
                {% if top_ordens_fichas %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-list-ol me-2"></i>Top 10 Ordens com Mais Fichas</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Código OS</th>
                                    <th>Máquina</th>
                                    <th class="text-end">Número de Fichas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ordem in top_ordens_fichas %}
                                <tr>
                                    <td><strong>{{ ordem.cd_ordemserv }}</strong></td>
                                    <td>{{ ordem.descr_maquina|truncatechars:60|default:"-" }}</td>
                                    <td class="text-end"><span class="badge bg-primary">{{ ordem.num_fichas }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Resumo Estatístico
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="text-primary mb-1">{{ setores_count }}</h4>
                                    <p class="text-muted mb-0">Setores Únicos</p>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="text-info mb-1">{{ unidades_count }}</h4>
                                    <p class="text-muted mb-0">Unidades Únicas</p>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="text-success mb-1">{{ total_fichas }}</h4>
                                    <p class="text-muted mb-0">Total de Fichas</p>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="text-warning mb-1">{{ taxa_ordens_com_fichas|floatformat:1 }}%</h4>
                                    <p class="text-muted mb-0">Taxa com Fichas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Função para formatar números no padrão brasileiro (1.234,56)
function formatarNumeroBR(numero, decimais = 0) {
    if (numero === null || numero === undefined || isNaN(numero)) {
        return '0';
    }
    const num = typeof numero === 'string' ? parseFloat(numero) : numero;
    return num.toLocaleString('pt-BR', {
        minimumFractionDigits: decimais,
        maximumFractionDigits: decimais
    });
}

// Formatar números na página após carregamento
document.addEventListener('DOMContentLoaded', function() {
    // Formatar números nos KPI cards
    const kpiNumbers = document.querySelectorAll('.kpi-card h2');
    kpiNumbers.forEach(el => {
        const text = el.textContent.trim();
        if (text.includes('%')) {
            const num = parseFloat(text.replace('%', '').replace(/\./g, '').replace(',', '.'));
            if (!isNaN(num)) {
                el.textContent = formatarNumeroBR(num, 1) + '%';
            }
        } else {
            const num = parseInt(text.replace(/\D/g, ''));
            if (!isNaN(num)) {
                el.textContent = formatarNumeroBR(num);
            }
        }
    });
    
    // Formatar números nos small texts dos KPI cards
    const kpiSmallTexts = document.querySelectorAll('.kpi-card small.text-muted');
    kpiSmallTexts.forEach(el => {
        const text = el.textContent;
        const match = text.match(/(\d+)\s+com\s+\/\s+(\d+)\s+sem/);
        if (match) {
            const num1 = parseInt(match[1]);
            const num2 = parseInt(match[2]);
            if (!isNaN(num1) && !isNaN(num2)) {
                el.textContent = formatarNumeroBR(num1) + ' com / ' + formatarNumeroBR(num2) + ' sem';
            }
        }
    });
});

// Gráfico de Pizza: Distribuição por Tipo de Ordem (descr_tpordservtv)
const tiposOSEl = document.getElementById('tiposOSChart');
if (tiposOSEl) {
    const tiposOSCtx = tiposOSEl.getContext('2d');
    new Chart(tiposOSCtx, {
        type: 'pie',
        data: {
            labels: {{ tipos_os_labels|safe }},
            datasets: [{
                data: {{ tipos_os_data|safe }},
                backgroundColor: [
                    '#dc3545', '#0d6efd', '#198754', '#ffc107', '#0dcaf0',
                    '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += formatarNumeroBR(context.parsed);
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Linha: Evolução Temporal
const temporalEl = document.getElementById('temporalChart');
if (temporalEl) {
    const temporalCtx = temporalEl.getContext('2d');
    const mesesLabels = {{ meses_labels|safe }};
    const mesesData = {{ meses_data|safe }};
    
    if (mesesLabels && mesesLabels.length > 0 && mesesData && mesesData.length > 0) {
        new Chart(temporalCtx, {
            type: 'line',
            data: {
                labels: mesesLabels,
                datasets: [{
                    label: 'Ordens de Serviço',
                    data: mesesData,
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Ordens de Serviço: ' + formatarNumeroBR(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatarNumeroBR(value);
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    } else {
        temporalCtx.fillStyle = '#999';
        temporalCtx.font = '16px Arial';
        temporalCtx.textAlign = 'center';
        temporalCtx.fillText('Nenhum dado disponível', temporalEl.width / 2, temporalEl.height / 2);
    }
}

// Gráfico de Pizza: Distribuição por Setor
const setoresEl = document.getElementById('setoresChart');
if (setoresEl) {
    const setoresCtx = setoresEl.getContext('2d');
    new Chart(setoresCtx, {
        type: 'pie',
        data: {
            labels: {{ setores_labels|safe }},
            datasets: [{
                data: {{ setores_data|safe }},
                backgroundColor: [
                    '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
                    '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += formatarNumeroBR(context.parsed);
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Barras: Ordens por Unidade
const unidadesEl = document.getElementById('unidadesChart');
if (unidadesEl) {
    const unidadesCtx = unidadesEl.getContext('2d');
    new Chart(unidadesCtx, {
        type: 'bar',
        data: {
            labels: {{ unidades_labels|safe }},
            datasets: [{
                label: 'Ordens',
                data: {{ unidades_data|safe }},
                backgroundColor: '#0dcaf0'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Ordens: ' + formatarNumeroBR(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatarNumeroBR(value);
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Barras Horizontal: Top Máquinas
const maquinasEl = document.getElementById('maquinasChart');
if (maquinasEl) {
    const maquinasCtx = maquinasEl.getContext('2d');
    new Chart(maquinasCtx, {
        type: 'bar',
        data: {
            labels: {{ maquinas_labels|safe }},
            datasets: [{
                label: 'Ordens',
                data: {{ maquinas_data|safe }},
                backgroundColor: '#ffc107'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Ordens: ' + formatarNumeroBR(context.parsed.x);
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatarNumeroBR(value);
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Barras: Top Executores
const executoresEl = document.getElementById('executoresChart');
if (executoresEl) {
    const executoresCtx = executoresEl.getContext('2d');
    new Chart(executoresCtx, {
        type: 'bar',
        data: {
            labels: {{ executores_labels|safe }},
            datasets: [{
                label: 'Ordens Executadas',
                data: {{ executores_data|safe }},
                backgroundColor: '#6c757d'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Ordens Executadas: ' + formatarNumeroBR(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatarNumeroBR(value);
                        }
                    }
                }
            }
        }
    });
}

// Gráfico de Barras: Top Executores de Fichas
const executoresFichasEl = document.getElementById('executoresFichasChart');
if (executoresFichasEl) {
    const executoresFichasCtx = executoresFichasEl.getContext('2d');
    new Chart(executoresFichasCtx, {
        type: 'bar',
        data: {
            labels: {{ executores_fichas_labels|safe }},
            datasets: [{
                label: 'Fichas Executadas',
                data: {{ executores_fichas_data|safe }},
                backgroundColor: '#0dcaf0'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Fichas Executadas: ' + formatarNumeroBR(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatarNumeroBR(value);
                        }
                    }
                }
            }
        }
    });
}

// Funções para selecionar/desmarcar todos os meses
function selecionarTodosMeses() {
    const checkboxes = document.querySelectorAll('input[name="mes"]');
    checkboxes.forEach(cb => cb.checked = true);
}

function desmarcarTodosMeses() {
    const checkboxes = document.querySelectorAll('input[name="mes"]');
    checkboxes.forEach(cb => cb.checked = false);
}
</script>
{% endblock %}
