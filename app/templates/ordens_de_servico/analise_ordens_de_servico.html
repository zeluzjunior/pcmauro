{% extends 'base.html' %}
{% load static %}

{% block title %}Análise de Ordens de Serviço{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid transparent;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .stat-card.border-primary { border-left-color: #0d6efd; }
    .stat-card.border-success { border-left-color: #198754; }
    .stat-card.border-info { border-left-color: #0dcaf0; }
    .stat-card.border-warning { border-left-color: #ffc107; }
    .stat-card.border-danger { border-left-color: #dc3545; }
    .stat-card.border-secondary { border-left-color: #6c757d; }
    
    .progress-bar-custom {
        height: 25px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .section-header {
        border-bottom: 3px solid;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .info-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white">Home</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Análise de Ordens de Serviço</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mt-3">
                    <i class="fas fa-chart-bar me-2"></i>Análise de Ordens de Serviço
                </h1>
                <p class="lead">Dashboard com estatísticas e análises das ordens de serviço</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container">
        <!-- Info Box -->
        <div class="info-box">
            <h4 class="mb-3">
                <i class="fas fa-info-circle me-2"></i>Visão Geral
            </h4>
            <p class="mb-0">
                Esta página apresenta uma análise consolidada das ordens de serviço,
                incluindo estatísticas sobre ordens preventivas, corretivas e outras análises relacionadas.
            </p>
        </div>

        <!-- Seção: Estatísticas Gerais -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0 section-header border-white">
                    <i class="fas fa-tasks me-2"></i>Estatísticas Gerais
                </h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-primary h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Total de Ordens</h6>
                                <h2 class="text-primary mb-0">{{ total_ordens }}</h2>
                                <small class="text-muted">Ordens cadastradas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Preventivas</h6>
                                <h2 class="text-success mb-0">{{ total_preventivas }}</h2>
                                <small class="text-muted">Ordens preventivas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-warning h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Corretivas</h6>
                                <h2 class="text-warning mb-0">{{ total_corretivas }}</h2>
                                <small class="text-muted">Ordens corretivas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-info h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Taxa Preventivas</h6>
                                <h2 class="text-info mb-0">
                                    {% if total_ordens > 0 %}
                                        {% widthratio total_preventivas total_ordens 100 %}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </h2>
                                <small class="text-muted">Percentual do total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção: Análise OrdemServicoCorretiva -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-white">
                <h4 class="mb-0 section-header border-white">
                    <i class="fas fa-tools me-2"></i>Análise de Ordens Corretivas (OrdemServicoCorretiva)
                </h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Com Máquina</h6>
                                <h2 class="text-success mb-0">{{ ordens_com_maquina }}</h2>
                                <small class="text-muted">{{ taxa_ordens_com_maquina|floatformat:1 }}% do total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-danger h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Sem Máquina</h6>
                                <h2 class="text-danger mb-0">{{ ordens_sem_maquina }}</h2>
                                <small class="text-muted">{{ ordens_sem_maquina|floatformat:0 }} ordens</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-info h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Com Executor</h6>
                                <h2 class="text-info mb-0">{{ ordens_com_executor }}</h2>
                                <small class="text-muted">{{ taxa_ordens_com_executor|floatformat:1 }}% do total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-secondary h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Com Solicitante</h6>
                                <h2 class="text-secondary mb-0">{{ ordens_com_solicitante }}</h2>
                                <small class="text-muted">{{ ordens_com_solicitante }} ordens</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ordens por Setor -->
                {% if ordens_por_setor %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-building me-2"></i>Top 10 Setores com Mais Ordens</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Setor</th>
                                    <th class="text-end">Total de Ordens</th>
                                    <th class="text-end">Percentual</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ordens_por_setor %}
                                <tr>
                                    <td>{{ item.descr_setormanut|truncatechars:50 }}</td>
                                    <td class="text-end"><strong>{{ item.total }}</strong></td>
                                    <td class="text-end">
                                        <span class="badge bg-primary">
                                            {% widthratio item.total total_corretivas 100 %}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                
                <!-- Ordens por Unidade -->
                {% if ordens_por_unidade %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-industry me-2"></i>Top 10 Unidades com Mais Ordens</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Unidade</th>
                                    <th class="text-end">Total de Ordens</th>
                                    <th class="text-end">Percentual</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ordens_por_unidade %}
                                <tr>
                                    <td>{{ item.nome_unid|truncatechars:50 }}</td>
                                    <td class="text-end"><strong>{{ item.total }}</strong></td>
                                    <td class="text-end">
                                        <span class="badge bg-success">
                                            {% widthratio item.total total_corretivas 100 %}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                
                <!-- Top Máquinas -->
                {% if top_maquinas %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-cogs me-2"></i>Top 10 Máquinas com Mais Ordens</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Descrição</th>
                                    <th class="text-end">Total de Ordens</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in top_maquinas %}
                                <tr>
                                    <td><strong>{{ item.cd_maquina }}</strong></td>
                                    <td>{{ item.descr_maquina|truncatechars:60|default:"-" }}</td>
                                    <td class="text-end"><span class="badge bg-warning text-dark">{{ item.total }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                
                <!-- Top Executores -->
                {% if top_executores %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-user-tie me-2"></i>Top 10 Funcionários Executores</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Funcionário</th>
                                    <th class="text-end">Total de Ordens</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in top_executores %}
                                <tr>
                                    <td>{{ item.nm_func_exec }}</td>
                                    <td class="text-end"><span class="badge bg-info">{{ item.total }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Seção: Análise OrdemServicoCorretivaFicha -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0 section-header border-white">
                    <i class="fas fa-file-alt me-2"></i>Análise de Fichas de Manutenção (OrdemServicoCorretivaFicha)
                </h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-primary h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Total de Fichas</h6>
                                <h2 class="text-primary mb-0">{{ total_fichas }}</h2>
                                <small class="text-muted">Fichas cadastradas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Ordens com Fichas</h6>
                                <h2 class="text-success mb-0">{{ ordens_com_fichas }}</h2>
                                <small class="text-muted">{{ taxa_ordens_com_fichas|floatformat:1 }}% do total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-warning h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Ordens sem Fichas</h6>
                                <h2 class="text-warning mb-0">{{ ordens_sem_fichas }}</h2>
                                <small class="text-muted">{{ ordens_sem_fichas }} ordens</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stat-card border-info h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted">Média Fichas/Ordem</h6>
                                <h2 class="text-info mb-0">{{ media_fichas_por_ordem|floatformat:1 }}</h2>
                                <small class="text-muted">Fichas por ordem</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Ordens com Fichas -->
                {% if top_ordens_fichas %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-list-ol me-2"></i>Top 10 Ordens com Mais Fichas</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Código OS</th>
                                    <th>Máquina</th>
                                    <th class="text-end">Número de Fichas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ordem in top_ordens_fichas %}
                                <tr>
                                    <td><strong>{{ ordem.cd_ordemserv }}</strong></td>
                                    <td>{{ ordem.descr_maquina|truncatechars:60|default:"-" }}</td>
                                    <td class="text-end"><span class="badge bg-primary">{{ ordem.num_fichas }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                
                <!-- Top Executores de Fichas -->
                {% if top_executores_fichas %}
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-users me-2"></i>Top 10 Executores de Fichas</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Funcionário</th>
                                    <th class="text-end">Total de Fichas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in top_executores_fichas %}
                                <tr>
                                    <td>{{ item.nm_func_exec_os }}</td>
                                    <td class="text-end"><span class="badge bg-success">{{ item.total }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Links Rápidos -->
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-link me-2"></i>Links Rápidos
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'consultar_corretivas_outros' %}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-tools me-2"></i>Consultar Ordens Corretivas
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'consultar_manutencoes_preventivas' %}" class="btn btn-outline-success w-100">
                            <i class="fas fa-calendar-check me-2"></i>Consultar Ordens Preventivas
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'analise_corretiva_outros' %}" class="btn btn-outline-warning w-100">
                            <i class="fas fa-chart-pie me-2"></i>Análise Corretivas
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

