{% extends 'base.html' %}
{% load static %}

{% block title %}Consultar Notas Fiscais{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        max-height: 70vh;
        overflow-y: auto;
        overflow-x: auto;
    }
    .table {
        width: 100%;
        table-layout: auto;
    }
    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
        white-space: nowrap;
        vertical-align: middle;
        text-align: center;
        padding: 12px 8px;
    }
    .table tbody td {
        vertical-align: middle;
        padding: 10px 8px;
    }
    .filter-input {
        width: 100%;
        padding: 4px 8px;
        font-size: 0.875rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 4px;
    }
    .filter-input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .filter-header {
        padding: 8px !important;
        background-color: #e9ecef;
    }
    .filter-row th {
        background-color: #e9ecef;
        padding: 4px 8px !important;
        position: sticky;
        top: 48px;
        z-index: 8;
    }
    .col-nota { min-width: 100px; }
    .col-emitente { min-width: 200px; }
    .col-data { min-width: 120px; }
    .col-valor { min-width: 120px; text-align: right; }
    .col-unidade { min-width: 150px; }
    .col-situacao { min-width: 150px; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white">Home</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Orçamento</li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Consultar Notas Fiscais</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mt-3">Consultar Notas Fiscais</h1>
                <p class="lead">Visualize e consulte todas as notas fiscais cadastradas</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container-fluid px-5">
        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-12">
                <form method="get" action="{% url 'consultar_notas_fiscais' %}" class="d-flex">
                    <input type="text" name="search" class="form-control me-2" placeholder="Buscar por nota, emitente, unidade, situação..." value="{{ search_query|default:'' }}">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </form>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total de Notas</h5>
                        <p class="card-text display-6">{{ total_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Emitentes Únicos</h5>
                        <p class="card-text display-6">{{ emitentes_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Unidades</h5>
                        <p class="card-text display-6">{{ unidades_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Valor Total</h5>
                        <p class="card-text display-6">R$ {{ valor_total|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-invoice me-2"></i>Notas Fiscais
                            <small class="ms-2">({{ notas.paginator.count }} registro{{ notas.paginator.count|pluralize }})</small>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <form method="get" action="{% url 'consultar_notas_fiscais' %}" id="filterForm">
                            <!-- Preservar busca geral -->
                            <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                            
                            <div class="table-container">
                                <table class="table table-hover table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th class="col-nota">Nota</th>
                                            <th class="col-emitente">Emitente</th>
                                            <th class="col-data">Data Emissão</th>
                                            <th class="col-valor">Total</th>
                                            <th class="col-unidade">Unidade</th>
                                            <th class="col-situacao">Situação</th>
                                            <th>Ações</th>
                                        </tr>
                                        <tr class="filter-row">
                                            <th>
                                                <input type="text" name="filtro_nota" class="filter-input" value="{{ filtro_nota|default:'' }}" placeholder="Nota">
                                            </th>
                                            <th>
                                                <input type="text" name="filtro_emitente" class="filter-input" value="{{ filtro_emitente|default:'' }}" placeholder="Emitente">
                                            </th>
                                            <th>
                                                <input type="text" name="filtro_data_emissao_inicio" class="filter-input" value="{{ filtro_data_emissao_inicio|default:'' }}" placeholder="Data Início">
                                            </th>
                                            <th>
                                                <input type="text" name="filtro_total_min" class="filter-input" value="{{ filtro_total_min|default:'' }}" placeholder="Min">
                                            </th>
                                            <th>
                                                <select name="filtro_unidade" class="filter-input">
                                                    <option value="">Todas</option>
                                                    {% for unidade in unidades_unicas %}
                                                    <option value="{{ unidade }}" {% if filtro_unidade == unidade %}selected{% endif %}>{{ unidade }}</option>
                                                    {% endfor %}
                                                </select>
                                            </th>
                                            <th>
                                                <select name="filtro_situacao" class="filter-input">
                                                    <option value="">Todas</option>
                                                    {% for situacao in situacoes_unicas %}
                                                    <option value="{{ situacao }}" {% if filtro_situacao == situacao %}selected{% endif %}>{{ situacao }}</option>
                                                    {% endfor %}
                                                </select>
                                            </th>
                                            <th>
                                                <button type="submit" class="btn btn-sm btn-primary w-100">
                                                    <i class="fas fa-filter"></i> Filtrar
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for nota in notas %}
                                        <tr>
                                            <td><span class="badge bg-primary">{{ nota.nota|default:"-" }}</span></td>
                                            <td>{{ nota.nome_fantasia_emitente|default:nota.emitente|default:"-"|truncatechars:40 }}</td>
                                            <td>{{ nota.data_emissao|default:"-" }}</td>
                                            <td class="text-end">
                                                {% if nota.total_nota %}
                                                    R$ {{ nota.total_nota|floatformat:2 }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>{{ nota.nome_unidade|default:nota.unidade|default:"-"|truncatechars:30 }}</td>
                                            <td>
                                                {% if nota.situacao %}
                                                    <span class="badge {% if 'AUTORIZADA' in nota.situacao %}bg-success{% elif 'PENDENTE' in nota.situacao %}bg-warning{% elif 'CANCELADA' in nota.situacao %}bg-danger{% else %}bg-secondary{% endif %}">
                                                        {{ nota.situacao|truncatechars:30 }}
                                                    </span>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'visualizar_nota_fiscal' nota.id %}" class="btn btn-sm btn-outline-primary" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-5">
                                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                                Nenhuma nota fiscal encontrada.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        {% if notas.has_other_pages %}
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if notas.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if filtro_nota %}filtro_nota={{ filtro_nota }}&{% endif %}{% if filtro_emitente %}filtro_emitente={{ filtro_emitente }}&{% endif %}{% if filtro_unidade %}filtro_unidade={{ filtro_unidade }}&{% endif %}{% if filtro_situacao %}filtro_situacao={{ filtro_situacao }}&{% endif %}page=1">Primeira</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if filtro_nota %}filtro_nota={{ filtro_nota }}&{% endif %}{% if filtro_emitente %}filtro_emitente={{ filtro_emitente }}&{% endif %}{% if filtro_unidade %}filtro_unidade={{ filtro_unidade }}&{% endif %}{% if filtro_situacao %}filtro_situacao={{ filtro_situacao }}&{% endif %}page={{ notas.previous_page_number }}">Anterior</a>
                            </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">
                                Página {{ notas.number }} de {{ notas.paginator.num_pages }}
                            </span>
                        </li>
                        
                        {% if notas.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if filtro_nota %}filtro_nota={{ filtro_nota }}&{% endif %}{% if filtro_emitente %}filtro_emitente={{ filtro_emitente }}&{% endif %}{% if filtro_unidade %}filtro_unidade={{ filtro_unidade }}&{% endif %}{% if filtro_situacao %}filtro_situacao={{ filtro_situacao }}&{% endif %}page={{ notas.next_page_number }}">Próxima</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if search_query %}search={{ search_query }}&{% endif %}{% if filtro_nota %}filtro_nota={{ filtro_nota }}&{% endif %}{% if filtro_emitente %}filtro_emitente={{ filtro_emitente }}&{% endif %}{% if filtro_unidade %}filtro_unidade={{ filtro_unidade }}&{% endif %}{% if filtro_situacao %}filtro_situacao={{ filtro_situacao }}&{% endif %}page={{ notas.paginator.num_pages }}">Última</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form when filter inputs change
document.addEventListener('DOMContentLoaded', function() {
    const filterInputs = document.querySelectorAll('.filter-input');
    const filterForm = document.getElementById('filterForm');
    
    filterInputs.forEach(input => {
        let timeout;
        input.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                filterForm.submit();
            }, 500); // Wait 500ms after user stops typing
        });
    });
    
    // Handle select changes immediately
    const filterSelects = document.querySelectorAll('select.filter-input');
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            filterForm.submit();
        });
    });
});
</script>
{% endblock %}
