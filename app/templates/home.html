{% extends 'base.html' %}
{% load static %}

{% block title %}Home - Meu Projeto Django{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 100%;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .fc-event {
        cursor: pointer;
    }
    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .chart-container-large {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    #mesSelecionadoHome {
        transition: all 0.3s ease;
        cursor: pointer;
        font-weight: 500;
    }
    #mesSelecionadoHome:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
    }
    #mesSelecionadoHome:focus {
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        border-color: #198754;
        outline: none;
    }
    /* Ensure KPI cards have equal height */
    .row .col-md-2.d-flex {
        min-height: 200px;
    }
    .row .col-md-2 .card.h-100 {
        min-height: 200px;
    }
</style>
{% endblock %}

{% block content %}


<!-- Hero Section -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="display-5 fw-bold mt-3">Planejamento e Controle de Manutenções - FAC [atulizado y]</h1>
            </div>
        </div>
    </div>
</section>

<!-- Current Week Info Section -->
{% if semana_atual %}
<section class="py-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 3px solid #0d6efd;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-center flex-wrap gap-4">
                    <!-- Icon Badge -->
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 56px; height: 56px;">
                            <i class="fas fa-calendar-week fs-5"></i>
                        </div>
                    </div>
                    
                    <!-- Week Info -->
                    <div class="flex-grow-1 text-center">
                        <div class="d-flex flex-column flex-md-row align-items-center justify-content-center flex-wrap gap-2 gap-md-3">
                            <!-- Week Label and Badge -->
                            <div class="d-flex align-items-center gap-2">
                                <span class="text-muted fw-medium">Semana Atual:</span>
                                <span class="badge bg-primary fs-6 px-3 py-2 shadow-sm" style="font-weight: 600; letter-spacing: 0.5px;">
                                    {{ semana_atual.semana }}
                                </span>
                            </div>
                            
                            <!-- Date Range -->
                            <div class="d-flex align-items-center flex-wrap justify-content-center gap-2 text-dark">
                                <div class="d-flex align-items-center gap-1">
                                    <i class="far fa-calendar-alt text-muted"></i>
                                    <span class="small text-muted">Início:</span>
                                    <span class="fw-semibold">{{ data_inicio_semana|date:"d/m/Y" }}</span>
                                </div>
                                <i class="fas fa-arrow-right text-muted mx-1" style="font-size: 0.75rem;"></i>
                                <div class="d-flex align-items-center gap-1">
                                    <span class="small text-muted">Fim:</span>
                                    <span class="fw-semibold">{{ data_fim_semana|date:"d/m/Y" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Cards: -->
<section class="py-5">
    <div class="container">
        <div class="row text-center justify-content-center">
            <div class="col-md-2 col-sm-6 mb-4 d-flex">
                <div class="card border-0 bg-primary text-white w-100 h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-clipboard2-data fa-2x mb-2"></i>
                        <h3 class="display-4 fw-bold">{{ manutencoes_corretivas|default:0 }}</h3>
                        <p class="mb-0">Manutenções Corretivas</p>
                        {% if semana_atual %}
                        <small class="opacity-75">Esta Semana</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-2 col-sm-6 mb-4 d-flex">
                <div class="card border-0 bg-success text-white w-100 h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h3 class="display-4 fw-bold">{{ manutencoes_preventivas|default:0 }}</h3>
                        <p class="mb-0">Manutenções Preventivas</p>
                        {% if semana_atual %}
                        <small class="opacity-75">Esta Semana</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-2 col-sm-6 mb-4 d-flex">
                <div class="card border-0 bg-warning text-white w-100 h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h3 class="display-4 fw-bold">R$ {{ valor_total_semana|floatformat:0|default:0 }}</h3>
                        <p class="mb-0">Valor Requisições</p>
                        {% if semana_atual %}
                        <small class="opacity-75">Esta Semana</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-2 col-sm-6 mb-4 d-flex">
                <div class="card border-0 bg-info text-white w-100 h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="fas fa-globe fa-2x mb-2"></i>
                        <h3 class="display-4 fw-bold">{{ total_requisicoes_semana|default:0 }}</h3>
                        <p class="mb-0">Requisições Almoxarifado</p>
                        {% if semana_atual %}
                        <small class="opacity-75">Esta Semana</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-2 col-sm-6 mb-4 d-flex">
                <div class="card border-0 bg-danger text-white w-100 h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-tools fa-2x mb-2"></i>
                        <h3 class="display-4 fw-bold">{{ total_maquinas|default:0 }}</h3>
                        <p class="mb-0">Máquinas</p>
                        <small class="opacity-75">Total</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-2 col-sm-6 mb-4 d-flex">
                <div class="card border-0 bg-secondary text-white w-100 h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-people fa-2x mb-2"></i>
                        <h3 class="display-4 fw-bold">{{ total_manutentores|default:0 }}</h3>
                        <p class="mb-0">Manutentores</p>
                        <small class="opacity-75">Total</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Charts Section -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- First Section: Daily Chart -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>Evolução Diária das Requisições por Mês
                            </h5>
                            <div class="d-flex align-items-center mt-2 mt-md-0">
                                <div class="input-group" style="max-width: 220px;">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-calendar-alt text-success"></i>
                                    </span>
                                    <input type="month" 
                                           class="form-control border-start-0" 
                                           id="mesSelecionadoHome" 
                                           value="{{ mes_ano_grafico|default:'' }}"
                                           style="font-weight: 500;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="dailyChartHome"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Second Section: Ordens Fechadas na Semana -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Ordens de Serviço Fechadas na Semana
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="ordensFechadasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</section>

<!-- Calendar Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-12">
                <h2 class="display-5 fw-bold">Calendário de Manutenções</h2>
                <p class="lead">Visualize ordens de serviço e eventos de manutenção</p>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            buttonText: {
                today: 'Hoje',
                month: 'Mês',
                week: 'Semana',
                list: 'Lista'
            },
            events: [
                {% for evento in eventos %}
                {
                    title: '{{ evento.title|escapejs }}',
                    start: '{{ evento.start }}',
                    {% if evento.end %}end: '{{ evento.end }}',{% endif %}
                    color: '{{ evento.color }}',
                    {% if evento.url %}url: '{{ evento.url }}',{% endif %}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            eventClick: function(info) {
                if (info.event.url) {
                    info.jsEvent.preventDefault();
                    window.location.href = info.event.url;
                }
            },
            height: 'auto',
            contentHeight: 600
        });
        
        calendar.render();
        
        // Gráfico de Linha: Evolução Diária do Mês (Home Page)
        const dailyCtxHome = document.getElementById('dailyChartHome');
        let dailyChartHome = null;
        
        function updateDailyChartHome(mesAno) {
            if (!mesAno) {
                // Se não há mês selecionado, usar mês atual
                const hoje = new Date();
                mesAno = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            }
            
            // Mostrar loading
            if (dailyChartHome) {
                dailyChartHome.destroy();
            }
            
            // Fazer requisição AJAX
            const apiUrl = '{% url "api_dados_diarios_requisicoes" %}';
            fetch(`${apiUrl}?mes_ano=${mesAno}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Erro ao carregar dados:', data.error);
                        return;
                    }
                    
                    if (dailyCtxHome) {
                        dailyChartHome = new Chart(dailyCtxHome.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    label: 'Quantidade de Requisições',
                                    data: data.data,
                                    borderColor: '#198754',
                                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y'
                                }, {
                                    label: 'Valor Total (R$)',
                                    data: data.valor,
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y1'
                                }, {
                                    label: 'Manutenções Terceiro',
                                    data: data.manutencao_terceiro || [],
                                    borderColor: '#ff9800',
                                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y'
                                }, {
                                    label: 'Visitas',
                                    data: data.visitas || [],
                                    borderColor: '#9c27b0',
                                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                                    tension: 0.4,
                                    fill: true,
                                    yAxisID: 'y'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Quantidade'
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Valor (R$)'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar dados diários:', error);
                });
        }
        
        // Inicializar gráfico com mês da semana atual
        if (dailyCtxHome) {
            const mesSelecionadoHome = document.getElementById('mesSelecionadoHome');
            const mesInicial = mesSelecionadoHome ? mesSelecionadoHome.value : null;
            
            if (mesInicial) {
                // Carregar dados iniciais com o mês da semana atual
                updateDailyChartHome(mesInicial);
            } else {
                // Fallback: usar mês atual se não houver valor definido
                const hoje = new Date();
                const mesFallback = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
                if (mesSelecionadoHome) {
                    mesSelecionadoHome.value = mesFallback;
                }
                updateDailyChartHome(mesFallback);
            }
            
            // Listener para mudança de mês
            if (mesSelecionadoHome) {
                mesSelecionadoHome.addEventListener('change', function() {
                    updateDailyChartHome(this.value);
                });
            }
        }
        
        // Gráfico de Barras: Ordens Fechadas na Semana
        const ordensFechadasCtx = document.getElementById('ordensFechadasChart');
        if (ordensFechadasCtx) {
            try {
                const ordensFechadasLabels = {{ ordens_fechadas_labels|safe }};
                const ordensFechadasData = {{ ordens_fechadas_data|safe }};
                
                // Verificar se temos dados válidos
                if (!ordensFechadasLabels || !ordensFechadasData || 
                    ordensFechadasLabels.length === 0 || ordensFechadasData.length === 0) {
                    console.warn('Dados do gráfico de ordens fechadas estão vazios ou inválidos');
                    // Criar gráfico vazio com mensagem
                    new Chart(ordensFechadasCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Sem dados'],
                            datasets: [{
                                label: 'Ordens Fechadas',
                                data: [0],
                                backgroundColor: 'rgba(200, 200, 200, 0.3)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false },
                                title: {
                                    display: true,
                                    text: 'Nenhuma ordem fechada nesta semana',
                                    position: 'top',
                                    font: { size: 14, color: '#666' }
                                }
                            }
                        }
                    });
                    return;
                }
                
                // Debug: log dos dados recebidos
                console.log('Dados do gráfico de ordens fechadas:', {
                    labels: ordensFechadasLabels,
                    data: ordensFechadasData,
                    total: ordensFechadasData.length > 0 ? ordensFechadasData.reduce((a, b) => a + b, 0) : 0,
                    labelsLength: ordensFechadasLabels.length,
                    dataLength: ordensFechadasData.length
                });
                
                new Chart(ordensFechadasCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ordensFechadasLabels,
                        datasets: [{
                            label: 'Ordens Fechadas',
                            data: ordensFechadasData,
                            backgroundColor: 'rgba(13, 110, 253, 0.8)',
                            borderColor: '#0d6efd',
                            borderWidth: 2,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Ordens Fechadas: ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    precision: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Quantidade de Ordens'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Dia da Semana'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar gráfico de ordens fechadas:', error);
                // Criar gráfico de erro
                try {
                    new Chart(ordensFechadasCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Erro'],
                            datasets: [{
                                label: 'Erro',
                                data: [0],
                                backgroundColor: 'rgba(220, 53, 69, 0.3)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false },
                                title: {
                                    display: true,
                                    text: 'Erro ao carregar dados do gráfico',
                                    position: 'top',
                                    font: { size: 14, color: '#dc3545' }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error('Erro ao criar gráfico de erro:', e);
                }
            }
        }
    });
</script>
{% endblock %}
