{% extends 'base.html' %}
{% load static %}

{% block title %}Análise de Manutentores{% endblock %}

{% block extra_css %}
<!-- Chart.js CSS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 30px;
    }
    .chart-container-large {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
    }
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .kpi-card {
        border-left: 4px solid;
    }
    .kpi-primary { border-left-color: #0d6efd; }
    .kpi-success { border-left-color: #198754; }
    .kpi-warning { border-left-color: #ffc107; }
    .kpi-info { border-left-color: #0dcaf0; }
    .kpi-danger { border-left-color: #dc3545; }
    .kpi-purple { border-left-color: #6f42c1; }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="py-5 text-white" style="background-image: linear-gradient(rgba(255, 152, 0, 0.5), rgba(255, 152, 0, 0.5)), url('{% static 'images/aurora_coop_castro.jpg' %}'); background-size: cover; background-position: center; background-repeat: no-repeat; position: relative;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-white">Home</a></li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Manutentores</li>
                        <li class="breadcrumb-item active text-white" aria-current="page">Análise</li>
                    </ol>
                </nav>
                <h1 class="display-4 fw-bold mt-3">Análise de Manutentores</h1>
                <p class="lead">Dashboard com análises e estatísticas dos manutentores cadastrados</p>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="py-5">
    <div class="container">
        <!-- KPI Cards -->
        <div class="row mb-5">
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-primary shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Total de Manutentores</h6>
                                <h2 class="mb-0 fw-bold">{{ total_count }}</h2>
                            </div>
                            <i class="bi bi-person-lines-fill fa-3x text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-success shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Últimos 30 Dias</h6>
                                <h2 class="mb-0 fw-bold">{{ manutentores_recentes }}</h2>
                            </div>
                            <i class="fas fa-calendar-day fa-3x text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-warning shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Mês Atual</h6>
                                <h2 class="mb-0 fw-bold">{{ manutentores_mes_atual }}</h2>
                            </div>
                            <i class="fas fa-calendar-alt fa-3x text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card stat-card kpi-card kpi-info shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Com Máquinas</h6>
                                <h2 class="mb-0 fw-bold">{{ manutentores_com_maquinas }}</h2>
                                <small class="text-muted">{{ percentual_com_maquinas }}% do total</small>
                            </div>
                            <i class="fas fa-cogs fa-3x text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-4 mb-4">
                <div class="card stat-card kpi-card kpi-purple shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Com Manutenções</h6>
                                <h2 class="mb-0 fw-bold">{{ manutentores_com_manutencoes }}</h2>
                            </div>
                            <i class="fas fa-tools fa-3x text-purple opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card stat-card kpi-card kpi-danger shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Total Máquinas Relacionadas</h6>
                                <h2 class="mb-0 fw-bold">{{ total_maquinas_relacionadas }}</h2>
                            </div>
                            <i class="fas fa-industry fa-3x text-danger opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card stat-card kpi-card kpi-success shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-2">Total Manutenções Relacionadas</h6>
                                <h2 class="mb-0 fw-bold">{{ total_manutencoes_relacionadas }}</h2>
                            </div>
                            <i class="fas fa-wrench fa-3x text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-5">
            <!-- Gráfico de Pizza: Distribuição por Turno -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Distribuição por Turno
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="turnosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Pizza: Distribuição por Local de Trabalho -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Distribuição por Local de Trabalho
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="locaisChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-5">
            <!-- Gráfico de Linha: Evolução Temporal -->
            <div class="col-md-8 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Evolução Temporal (Últimos 12 Meses)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="temporalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Doughnut: Distribuição de Máquinas -->
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Distribuição de Máquinas por Manutentor
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="distribuicaoMaquinasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 3 -->
        <div class="row mb-5">
            <!-- Gráfico de Barras: Top Cargos -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Top 10 Cargos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="cargosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Barras Horizontal: Top Manutentores por Máquinas -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Top 10 Manutentores por Quantidade de Máquinas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-large">
                            <canvas id="manutentoresMaquinasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="row mb-5">
            <!-- Tabela: Top Manutentores por Máquinas -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Ranking de Manutentores por Máquinas
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Matrícula</th>
                                        <th>Nome</th>
                                        <th class="text-center">Qtd Máquinas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in top_manutentores_maquinas %}
                                    <tr>
                                        <td><strong>{{ forloop.counter }}</strong></td>
                                        <td><span class="badge bg-primary">{{ item.manutentor.Matricula }}</span></td>
                                        <td>{{ item.manutentor.Nome|truncatewords:8 }}</td>
                                        <td class="text-center"><span class="badge bg-info">{{ item.total }}</span></td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">Nenhum dado disponível</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela: Top Manutentores por Manutenções -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Ranking de Manutentores por Manutenções
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Matrícula</th>
                                        <th>Nome</th>
                                        <th class="text-center">Qtd Manutenções</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in top_manutentores_manutencoes %}
                                    <tr>
                                        <td><strong>{{ forloop.counter }}</strong></td>
                                        <td><span class="badge bg-success">{{ item.manutentor.Matricula }}</span></td>
                                        <td>{{ item.manutentor.Nome|truncatewords:8 }}</td>
                                        <td class="text-center"><span class="badge bg-info">{{ item.total }}</span></td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">Nenhum dado disponível</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Pizza: Distribuição por Turno
    const turnosCtx = document.getElementById('turnosChart');
    if (turnosCtx) {
        new Chart(turnosCtx, {
            type: 'pie',
            data: {
                labels: {{ turnos_labels|safe }},
                datasets: [{
                    label: 'Quantidade de Manutentores',
                    data: {{ turnos_data|safe }},
                    backgroundColor: [
                        '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
                        '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    // Gráfico de Pizza: Distribuição por Local de Trabalho
    const locaisCtx = document.getElementById('locaisChart');
    if (locaisCtx) {
        new Chart(locaisCtx, {
            type: 'pie',
            data: {
                labels: {{ locais_labels|safe }},
                datasets: [{
                    label: 'Quantidade de Manutentores',
                    data: {{ locais_data|safe }},
                    backgroundColor: [
                        '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
                        '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    // Gráfico de Linha: Evolução Temporal
    const temporalCtx = document.getElementById('temporalChart');
    if (temporalCtx) {
        new Chart(temporalCtx, {
            type: 'line',
            data: {
                labels: {{ meses_labels|safe }},
                datasets: [{
                    label: 'Manutentores Cadastrados',
                    data: {{ meses_data|safe }},
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Gráfico de Doughnut: Distribuição de Máquinas
    const distribuicaoMaquinasCtx = document.getElementById('distribuicaoMaquinasChart');
    if (distribuicaoMaquinasCtx) {
        new Chart(distribuicaoMaquinasCtx, {
            type: 'doughnut',
            data: {
                labels: {{ distribuicao_maquinas_labels|safe }},
                datasets: [{
                    data: {{ distribuicao_maquinas_data|safe }},
                    backgroundColor: [
                        '#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0',
                        '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Gráfico de Barras: Top Cargos
    const cargosCtx = document.getElementById('cargosChart');
    if (cargosCtx) {
        new Chart(cargosCtx, {
            type: 'bar',
            data: {
                labels: {{ cargos_labels|safe }},
                datasets: [{
                    label: 'Manutentores',
                    data: {{ cargos_data|safe }},
                    backgroundColor: '#6c757d'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Gráfico de Barras Horizontal: Top Manutentores por Máquinas
    const manutentoresMaquinasCtx = document.getElementById('manutentoresMaquinasChart');
    if (manutentoresMaquinasCtx) {
        const manutentoresLabels = [
            {% for item in top_manutentores_maquinas %}
            '{{ item.manutentor.Nome|truncatewords:3 }} ({{ item.manutentor.Matricula }})'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        const manutentoresData = [
            {% for item in top_manutentores_maquinas %}
            {{ item.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        new Chart(manutentoresMaquinasCtx, {
            type: 'bar',
            data: {
                labels: manutentoresLabels,
                datasets: [{
                    label: 'Quantidade de Máquinas',
                    data: manutentoresData,
                    backgroundColor: '#dc3545'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}

